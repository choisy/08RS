---
title: "08RS data"
number-sections: true
format:
  html:
    toc: true
    toc-depth: 4
editor: source
editor_options: 
  chunk_output_type: console
#bibliography: references.bib
#csl: the-american-naturalist.csl
---

```{r include = FALSE, eval = FALSE}
knitr::purl("data.qmd", "tmp.R", documentation = FALSE)
source("tmp.R")
file.remove("tmp.R")

add_nojekyll <- function() {
  file <- ".nojekyll"
  file.create(file)
  gert::git_add(file)
  gert::git_commit("Adding the .nojekyll file")
  gert::git_push()
}
```

```{r include = FALSE}
par2 <- function(...) par(..., mgp = c(1.5, .5, 0), bty = "n")

knitr::knit_hooks$set(
  margin1 = function(before, options, envir) {
    if (before) par2(plt = c(.105, .97, .15, .95)) else NULL
  })

eps <- .8
knitr::opts_chunk$set(margin1    = TRUE,
                      fig.retina = 2,
                      fig.align  = "center",
                      fig.height = eps * 5, # default is 5
                      fig.width  = eps * 7) # default is 7
```


## Global parameters

The path to the data folder on the local computer:

```{r}
root <- "~/Library/CloudStorage/OneDrive-OxfordUniversityClinicalResearchUnit/"
data_folder <- paste0(root, "GitHub/choisy/08RS/")
``` 


## Packages

Required packages:

```{r}
required <- c("readxl", "purrr", "dplyr")
```

Loading packages:

```{r message = FALSE}
library(dplyr)
```


## Loading the CRF data

A function that reads all the tabs of an excel file in the data folder:

```{r}
read_excel_file <- function(file) {
  file <- paste0(data_folder, file)
  sheets_names <- readxl::excel_sheets(file)
  sheets_names |>
    purrr::map(~ readxl::read_excel(file, .x)) |> 
    setNames(sheets_names)
}
```

Reading the `CTU08RS_Data.xlsx` data file:

```{r}
CRF <- read_excel_file("6-11-2024-CTU08RS_Data.xlsx")
```

The names of the data frames in Saras' code and in the new data file:

```{r}
# CliRes        Saras           Definition
# ------------------------------------------------------------------
# ENROL         data_EN         enrollment
# HIST          data_HIST       history at enrollment
# CONHIST       CONHIST         contact history at enrollment
# EXAM          data_EX         symptoms and signs at enrollment
# LAB           data_LAB        lab results at admission
# NEU           data_NEU        neurological exam
# DAILY         data_Daily      daily review
# MED           data_MED        medications
# DEVSOCSED     data_DEV        development and socio-economic data
# DISC          data_DISC       discharge summary
# FUP           data_FUP        first follow-up day 7-10
# FUP_II        data_FUP6m      first follow-up month 6
# FUP_III       data_FUP18m     first follow-up month 18
# NEURO         data_NEURO      neurological assessment
# ABC           data_MABC       movement ABC-2
```

Reformatting the data

```{r}
CRF2 <- CRF[c("ENROL", "HIST", "EXAM", "DEVSOCSED", "DISC", "FUP", "FUP_II", "FUP_III",
              "ABC")]

CRF2$ENROL <- CRF2$ENROL |> 
  select(ParNo, DateEnrol, Gender, DateBirth) |> 
  mutate(across(Gender, ~ c("male", "female")[.x]),
         across(starts_with("Date"), as.Date))

CRF2$HIST <- CRF2$HIST |> 
  select(ParNo, DateIllness, DateAdmHTD, DateAdmHTD, DateAdmHosp) |> 
  mutate(across(starts_with("Date"), as.Date))

CRF2$EXAM <- CRF2$EXAM |> 
  select(ParNo, headCircumference)

CRF2$DEVSOCSED <- CRF2$DEVSOCSED |> 
  select(ParNo, MomEdu, Toilet, Refrigerator, AirConditioner, Motorbike, Water) |> 
  mutate(across(c("Refrigerator", "AirConditioner"), ~ .x < 2))

CRF2$DISC <- CRF2$DISC |> 
  select(ParNo, DateDisc, GradeHFMD, DateHFMD, TreatSepsis, PCR, EV71, Outcome,
         Seizure, Hypertonicity, LimbPara, CNP, DiapWeak, Trache, Nasotube,
         BehaveChange) |> 
  mutate(across(starts_with("Date"), as.Date)) |> 
  mutate(across(c("TreatSepsis", "EV71"), ~ .x < 2))

CRF2$FUP <- CRF2$FUP |> 
  select(ParNo, Trache) |> 
  mutate(across("Trache", ~ .x < 2))

CRF2$FUP_II <- CRF2$FUP_II |> 
  select(ParNo, Trache) |> 
  mutate(across("Trache", ~ .x < 2))

CRF2$FUP_III <- CRF2$FUP_III |> 
  select(ParNo, Trache) |> 
  mutate(across("Trache", ~ .x < 2))

CRF2$ABC <- CRF2$ABC |> 
  select(ParNo, Gender, DateBirth, MD1, MD2, MD3, AC1, AC2, BAL1, BAL2, BAL3) |> 
  mutate(across(Gender, ~ c("male", "female")[.x]),
         across(starts_with("Date"), as.Date))
```

```{r}
tmp <- CRF2 |>
  map(~ .x$ParNo) |> 
  map(unique)

map_int(tmp, length)

map(tmp[-1], setdiff, y = tmp[[1]])
```

Patient `03-354` is present only in the `ABC` dataset:

```{r}
map_lgl(tmp, is.element, el = "03-354")
```

```{r}

```



```{r}
crf <- list(devsocsed = list(MomEdu = c("Never been to school",
                                        "Attended some primary school",
                                        "Completed primary school (5th gr)",
                                        "Completed lower secondary school (9th gr)",
                                        "Completed higher secondary school (12th gr)",
                                        "Completed university/college degree",
                                        "Completed postgraduate degree"),
                             Toilet = c("Own flush toilet",
                                        "Shared flush toilet",
                                        "Traditional pit toilet",
                                        "Ventilation improved pit toilet",
                                        "No facility/bush/field",
                                        "None of above"),
                             Water  = c("Private tap",
                                        "Public standpipe",
                                        "Bottled water",
                                        "Well in own residence",
                                        "Public well",
                                        "Rain water",
                                        "Spring",
                                        "River/lake/pond", NA,
                                        "None of the above")),
            disc = list(GradeHFMD   = c("grade 1",
                                        "grade 2a",
                                        "grade 2b(1)",
                                        "grade 2b(2)",
                                        "grade 3",
                                        "grade 4",
                                        "Not Applicable"),
                        PCR         = c("EV positive",
                                        "EV negative",
                                        "Not done"),
                        Outcome     = c("Full recovery without complication",
                                        "Incomplete recovery",
                                        "Transferred to another hospital",
                                        "Taken home without approval",
                                        "Death",
                                        "Discharged to die")),
            ABC = setNames(map(1:8, ~ c(D = "Done",
                                        F = "Failure",
                                        I = "Inappropriate",
                                        R = "Refusal")),
                           c("MD1", "MD2", "MD3", "AC1", "AC2", "BAL1", "BAL2", "BAL3")))
```


## Temporary

```{r}
saras <- readr::read_csv(paste0(root, "GitHub/choisy/08RS/complete data including all withdrawals_updated26_3_21.csv"))
names_saras <- names(saras)
tmp <- setNames(map(names_saras, ~ which(map_lgl(names_crf, is.element, el = .x))), names_saras)
tmp <- tmp[map_dbl(tmp, length) > 0]
unique(unlist(map(tmp, names)))
```


## Loading the Bayley data

```{r}
Bayley <- read_excel_file("12-9-2025-Bayley_v3_P1_Data.xlsx")
```

```{r}
names(Bayley)
```


